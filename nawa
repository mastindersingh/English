from flask import Flask, render_template_string
import requests
from requests.auth import HTTPBasicAuth
from datetime import datetime

app = Flask(__name__)

# Function to generate URLs for Wells Fargo clusters
def generate_url(cluster_identifier, endpoint):
    base_url = ""
    if "oxm" in cluster_identifier:
        if endpoint == "status":
            base_url = f"https://{cluster_identifier}-elasticsearch.net"
        elif endpoint == "health":
            base_url = f"https://{cluster_identifier}-api-elasticsearch.net"
    else:
        if endpoint == "status":
            base_url = f"https://{cluster_identifier}-elasticsearch.com"
        elif endpoint == "health":
            base_url = f"https://{cluster_identifier}-api-elasticsearch.com"
    return f"{base_url}/{endpoint}"

# Credentials function - Update with appropriate logic
def get_credentials(cluster_identifier):
    # Replace with appropriate logic for credentials
    return ('your_username', 'your_password')

@app.route("/")
def home():
    wf_clusters = [f"o-prod{i}" for i in range(1, 3)] + [f"prod{i}" for i in range(1, 8)]
    results = []
    today_date = datetime.now().strftime("%Y-%m-%d")

    for cluster in wf_clusters:
        status_url = generate_url(cluster, "status")
        health_url = generate_url(cluster, "health")
        username, password = get_credentials(cluster)

        try:
            es_response = requests.get(status_url, auth=HTTPBasicAuth(username, password))
            kb_response = requests.get(health_url, auth=HTTPBasicAuth(username, password))

            es_response.raise_for_status()
            kb_response.raise_for_status()

            es_data = es_response.json()
            kb_data = kb_response.json()

            es_health_summary = {
                "Master Stability": es_data.get("indicators", {}).get("master_is_stable", {}).get("status", "N/A"),
                "Shards Availability": es_data.get("indicators", {}).get("shards_availability", {}).get("status", "N/A"),
                "Disk": es_data.get("indicators", {}).get("disk", {}).get("status", "N/A"),
            }

            kb_overall_status = kb_data.get("status", {}).get("overall", {}).get("level", "N/A")

            combined_data = {
                "cluster_identifier": cluster,
                "elasticsearch_health": es_health_summary,
                "kibana_status": kb_overall_status
            }

            results.append(combined_data)
        except requests.RequestException as e:
            print(f"Error fetching data for Wells Fargo cluster {cluster}: {e}")

    template = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Wells Fargo Clusters Status and Health Report</title>
        <style>
            body { font-family: Arial, sans-serif; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .available { color: green; }
            .not_available { color: red; }
        </style>
    </head>
    <body>
        <h2>Wells Fargo Clusters Status and Health Report as of {{ today_date }}</h2>
        <table>
            <tr>
                <th>Cluster Identifier</th>
                <th>Elasticsearch Health Report</th>
                <th>Kibana Status</th>
            </tr>
            {% for data in results %}
            <tr>
                <td>{{ data.cluster_identifier }}</td>
                <td>
                    <ul>
                        {% for key, value in data.elasticsearch_health.items() %}
                            <li>{{ key }}: <span class="{{ 'available' if value == 'green' else 'not_available' }}">{{ value }}</span></li>
                        {% endfor %}
                    </ul>
                </td>
                <td><span class="{{ 'available' if data.kibana_status == 'available' else 'not_available' }}">{{ data.kibana_status }}</span></td>
            </tr>
            {% endfor %}
        </table>
    </body>
    </html>
    """

    return render_template_string(template, results=results, today_date=today_date)

if __name__ == "__main__":
    app.run(debug=True)
